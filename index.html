<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polygon Area Calculator</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Custom scrollbar to allow horizontal scrolling for wide matrices on mobile */
        .overflow-x-auto::-webkit-scrollbar {
            height: 6px;
        }

        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-2xl mx-auto space-y-6">

        <div class="text-center space-y-2">
            <h1 class="text-3xl font-bold text-indigo-600">Polygon Area Calculator</h1>
            <p class="text-gray-500 text-sm">Shoelace Formula with KaTeX Matrix & Chart.js</p>
        </div>

        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
            <h2 class="text-lg font-semibold mb-4 text-gray-700">Enter Coordinates</h2>

            <div id="points-container" class="space-y-3 mb-4">
            </div>

            <div class="flex gap-3">
                <button onclick="addPoint()"
                    class="flex-1 bg-indigo-50 text-indigo-600 font-semibold py-2.5 rounded-xl hover:bg-indigo-100 transition active:scale-95">
                    + Add Point
                </button>
                <button onclick="calculateArea()"
                    class="flex-1 bg-indigo-600 text-white font-semibold py-2.5 rounded-xl hover:bg-indigo-700 transition shadow-md active:scale-95">
                    Calculate
                </button>
            </div>
            <p id="error-msg" class="text-red-500 text-sm mt-3 hidden text-center"></p>
        </div>

        <div id="results" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hidden space-y-8">

            <div>
                <h3 class="font-semibold text-gray-700 border-b pb-2 mb-3">1. Matrix Setup</h3>
                <p class="text-sm text-gray-500 mb-2">The last point connects back to the first point to close the
                    polygon.</p>
                <div class="overflow-x-auto bg-white py-4 rounded-xl border border-gray-200">
                    <div id="matrix-content" class="text-center"></div>
                </div>
            </div>

            <div>
                <h3 class="font-semibold text-gray-700 border-b pb-2 mb-3">2. Step-by-Step Calculation</h3>
                <div class="space-y-4 text-sm font-mono">

                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-blue-900">
                        <strong class="block mb-2">Sum 1 (Forward Diagonals ↘):</strong>
                        <div id="steps-forward" class="space-y-1"></div>
                        <div class="mt-2 pt-2 border-t border-blue-200 font-bold">
                            Total Sum 1 = <span id="sum1-result"></span>
                        </div>
                    </div>

                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 text-orange-900">
                        <strong class="block mb-2">Sum 2 (Backward Diagonals ↗):</strong>
                        <div id="steps-backward" class="space-y-1"></div>
                        <div class="mt-2 pt-2 border-t border-orange-200 font-bold">
                            Total Sum 2 = <span id="sum2-result"></span>
                        </div>
                    </div>

                    <div class="bg-green-50 p-4 rounded-xl border border-green-100 text-green-900 text-base">
                        <strong class="block mb-2 text-green-800">3. Final Area:</strong>
                        <p>Area = 0.5000 × | Sum 1 - Sum 2 |</p>
                        <p id="final-formula" class="mt-1"></p>
                        <p class="text-xl font-bold mt-2 text-green-700" id="final-area"></p>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="font-semibold text-gray-700 border-b pb-2 mb-3">4. Polygon Plot</h3>
                <div class="h-64 w-full border border-gray-200 rounded-xl p-2 bg-gray-50">
                    <canvas id="polygonChart"></canvas>
                </div>
            </div>

        </div>
    </div>

    <script>
        let points = [
            { x: '', y: '' },
            { x: '', y: '' },
            { x: '', y: '' } // Start with a triangle
        ];
        let chartInstance = null; // Store chart instance to destroy/recreate

        // Ensure exactly 4 decimal places
        function round4(num) {
            return Number(Math.round(num + 'e4') + 'e-4').toFixed(4);
        }

        function renderPoints() {
            let html = '';
            points.forEach((p, index) => {
                html += `
                    <div class="flex items-center gap-2">
                        <div class="w-8 text-center text-gray-400 font-mono text-sm">P${index + 1}</div>
                        <input type="number" step="any" value="${p.x}" onchange="updatePoint(${index}, 'x', this.value)" placeholder="X" class="flex-1 w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="number" step="any" value="${p.y}" onchange="updatePoint(${index}, 'y', this.value)" placeholder="Y" class="flex-1 w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button onclick="removePoint(${index})" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition" title="Remove point">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
            });
            document.getElementById('points-container').innerHTML = html;
        }

        function updatePoint(index, axis, value) {
            points[index][axis] = value;
        }

        function addPoint() {
            points.push({ x: '', y: '' });
            renderPoints();
            document.getElementById('results').classList.add('hidden');
        }

        function removePoint(index) {
            if (points.length <= 3) {
                showError("A polygon must have at least 3 points.");
                return;
            }
            points.splice(index, 1);
            renderPoints();
            document.getElementById('results').classList.add('hidden');
        }

        function showError(msg) {
            const errEl = document.getElementById('error-msg');
            errEl.textContent = msg;
            errEl.classList.remove('hidden');
        }

        function calculateArea() {
            document.getElementById('error-msg').classList.add('hidden');

            let parsedPoints = [];
            for (let i = 0; i < points.length; i++) {
                let x = parseFloat(points[i].x);
                let y = parseFloat(points[i].y);
                if (isNaN(x) || isNaN(y)) {
                    showError(`Please enter valid numbers for Point ${i + 1}`);
                    return;
                }
                parsedPoints.push({ x: round4(x), y: round4(y) });
            }

            // Close the polygon
            parsedPoints.push(parsedPoints[0]);

            renderKaTeXMatrix(parsedPoints);
            processSteps(parsedPoints);
            drawPlot(parsedPoints);

            document.getElementById('results').classList.remove('hidden');
        }

        function renderKaTeXMatrix(pts) {
            // Build a LaTeX string for the determinant matrix (\begin{vmatrix})
            let latex = "\\begin{vmatrix} ";
            latex += pts.map(p => p.x).join(" & ");
            latex += " \\\\ "; // Next row
            latex += pts.map(p => p.y).join(" & ");
            latex += " \\end{vmatrix}";

            // Render it into the div
            katex.render(latex, document.getElementById('matrix-content'), {
                throwOnError: false,
                displayMode: true // Centers it and makes it larger
            });
        }

        function processSteps(pts) {
            let sum1 = 0;
            let sum2 = 0;
            let stepsFwd = '';
            let stepsBwd = '';

            for (let i = 0; i < pts.length - 1; i++) {
                // Forward (X_i * Y_i+1)
                let x1 = parseFloat(pts[i].x);
                let y2 = parseFloat(pts[i + 1].y);
                let prod1 = parseFloat(round4(x1 * y2));
                sum1 = parseFloat(round4(sum1 + prod1));

                stepsFwd += `<div>(${pts[i].x} × ${pts[i + 1].y}) = ${round4(prod1)} <span class="text-blue-400 text-xs ml-2">Running: ${round4(sum1)}</span></div>`;

                // Backward (Y_i * X_i+1)
                let y1 = parseFloat(pts[i].y);
                let x2 = parseFloat(pts[i + 1].x);
                let prod2 = parseFloat(round4(y1 * x2));
                sum2 = parseFloat(round4(sum2 + prod2));

                stepsBwd += `<div>(${pts[i].y} × ${pts[i + 1].x}) = ${round4(prod2)} <span class="text-orange-400 text-xs ml-2">Running: ${round4(sum2)}</span></div>`;
            }

            document.getElementById('steps-forward').innerHTML = stepsFwd;
            document.getElementById('sum1-result').textContent = round4(sum1);
            document.getElementById('steps-backward').innerHTML = stepsBwd;
            document.getElementById('sum2-result').textContent = round4(sum2);

            // Final Calculation
            let diff = parseFloat(round4(Math.abs(sum1 - sum2)));
            let area = parseFloat(round4(diff * 0.5));

            document.getElementById('final-formula').textContent = `Area = 0.5000 × | ${round4(sum1)} - ${round4(sum2)} | = 0.5000 × ${round4(diff)}`;
            document.getElementById('final-area').textContent = `${round4(area)} units²`;
        }

        function drawPlot(pts) {
            const ctx = document.getElementById('polygonChart').getContext('2d');

            // Destroy previous chart if it exists to avoid overlapping
            if (chartInstance) {
                chartInstance.destroy();
            }

            // Map string coordinates back to floats for Chart.js
            const plotData = pts.map(p => ({ x: parseFloat(p.x), y: parseFloat(p.y) }));

            chartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Polygon Shape',
                        data: plotData,
                        showLine: true, // Connect the dots
                        fill: true, // Fill the inside
                        backgroundColor: 'rgba(79, 70, 229, 0.2)', // Light indigo fill
                        borderColor: 'rgba(79, 70, 229, 1)', // Solid indigo border
                        pointBackgroundColor: '#ef4444', // Red points
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `(${ctx.parsed.x}, ${ctx.parsed.y})`
                            }
                        }
                    },
                    scales: {
                        x: { type: 'linear', position: 'bottom', grid: { color: '#f3f4f6' } },
                        y: { grid: { color: '#f3f4f6' } }
                    }
                }
            });
        }

        // Init
        renderPoints();
    </script>
</body>

</html>